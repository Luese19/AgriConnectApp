<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">
    <title>Chat Support - Buyer Dashboard</title>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div class="container-fluid">
        <div class="row">
            <nav th:replace="~{fragments/buyer-sidebar :: buyer-sidebar}"></nav>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Chat Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="bi bi-chat-dots me-2"></i>Chat Support</h1>
                    <div class="input-group search-container" style="max-width: 300px;">
                        <input type="text" class="form-control" placeholder="Search messages..." aria-label="Search messages">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="row">
                    <!-- Contact List -->
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Recent Contacts</h5>
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
                                        <i class="bi bi-plus-circle me-1"></i>New Chat
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush">
                                    <!-- Contact 1 - Active -->
                                    <a href="#" class="list-group-item list-group-item-action active py-3" aria-current="true" data-contact="green-valley">
                                        <div class="d-flex w-100 align-items-center">
                                            <img src="https://via.placeholder.com/50x50?text=GV" class="rounded-circle me-3" alt="Green Valley Farm">
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Green Valley Farm</h6>
                                                    <small class="text-muted">5 min</small>
                                                </div>
                                                <p class="mb-0 text-truncate small">Thanks for your order! Let me know if...</p>
                                            </div>
                                        </div>
                                    </a>
                                    
                                    <!-- Contact 2 -->
                                    <a href="#" class="list-group-item list-group-item-action py-3" data-contact="alpine-dairy">
                                        <div class="d-flex w-100 align-items-center">
                                            <img src="https://via.placeholder.com/50x50?text=AD" class="rounded-circle me-3" alt="Alpine Dairy Co-op">
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Alpine Dairy Co-op</h6>
                                                    <small class="text-muted">2 hrs</small>
                                                </div>
                                                <p class="mb-0 text-truncate small">Your order has been shipped and will...</p>
                                            </div>
                                        </div>
                                    </a>
                                    
                                    <!-- Contact 3 -->
                                    <a href="#" class="list-group-item list-group-item-action py-3" data-contact="bee-haven">
                                        <div class="d-flex w-100 align-items-center">
                                            <img src="https://via.placeholder.com/50x50?text=BH" class="rounded-circle me-3" alt="Bee Haven Apiaries">
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Bee Haven Apiaries</h6>
                                                    <small class="text-muted">Yesterday</small>
                                                </div>
                                                <p class="mb-0 text-truncate small">We have a new shipment of wildflower...</p>
                                            </div>
                                        </div>
                                    </a>
                                    
                                    <!-- Contact 4 -->
                                    <a href="#" class="list-group-item list-group-item-action py-3" data-contact="sunny-meadows">
                                        <div class="d-flex w-100 align-items-center">
                                            <img src="https://via.placeholder.com/50x50?text=SM" class="rounded-circle me-3" alt="Sunny Meadows">
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Sunny Meadows</h6>
                                                    <small class="text-muted">May 10</small>
                                                </div>
                                                <p class="mb-0 text-truncate small">Thank you for your purchase! How did...</p>
                                            </div>
                                        </div>
                                    </a>
                                    
                                    <!-- Contact 5 -->
                                    <a href="#" class="list-group-item list-group-item-action py-3" data-contact="berry-good">
                                        <div class="d-flex w-100 align-items-center">
                                            <img src="https://via.placeholder.com/50x50?text=BG" class="rounded-circle me-3" alt="Berry Good Farm">
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">Berry Good Farm</h6>
                                                    <small class="text-muted">May 7</small>
                                                </div>
                                                <p class="mb-0 text-truncate small">Hi there! Strawberry season starts...</p>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img src="https://via.placeholder.com/40x40?text=GV" class="rounded-circle me-2" alt="Green Valley Farm">
                                        <div>
                                            <h5 class="mb-0">Green Valley Farm</h5>
                                            <small class="text-muted">
                                                <i class="bi bi-circle-fill text-success me-1" style="font-size: 0.5rem;"></i>Online
                                            </small>
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="chatOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatOptionsDropdown">
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>View Profile</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-basket me-2"></i>View Products</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-bell me-2"></i>Mute Notifications</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-x-circle me-2"></i>Clear Conversation</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Chat Messages Container -->
                            <div class="card-body chat-messages p-4" style="height: 400px; overflow-y: auto;">
                                <!-- Date Separator -->
                                <div class="text-center mb-3">
                                    <span class="badge bg-light text-dark">Today, May 13, 2025</span>
                                </div>
                                
                                <!-- Farmer Message -->
                                <div class="d-flex mb-3">
                                    <img src="https://via.placeholder.com/40x40?text=GV" class="rounded-circle me-2" width="40" height="40" alt="Green Valley Farm">
                                    <div class="card message-card received-message">
                                        <div class="card-body py-2 px-3">
                                            <p class="mb-0">Hello! Thank you for your recent order of fresh tomatoes and herbs. Your order has been packed and is ready for shipping.</p>
                                        </div>
                                        <small class="text-muted ms-2 mb-1">10:23 AM</small>
                                    </div>
                                </div>
                                
                                <!-- Buyer Message -->
                                <div class="d-flex flex-row-reverse mb-3">
                                    <div class="card message-card sent-message">
                                        <div class="card-body py-2 px-3">
                                            <p class="mb-0">That's great news! When can I expect delivery?</p>
                                        </div>
                                        <small class="text-muted me-2 mb-1 text-end">10:25 AM</small>
                                    </div>
                                </div>
                                
                                <!-- Farmer Message -->
                                <div class="d-flex mb-3">
                                    <img src="https://via.placeholder.com/40x40?text=GV" class="rounded-circle me-2" width="40" height="40" alt="Green Valley Farm">
                                    <div class="card message-card received-message">
                                        <div class="card-body py-2 px-3">
                                            <p class="mb-0">Our delivery driver will be in your area tomorrow between 2-5 PM. Is that a good time for you?</p>
                                        </div>
                                        <small class="text-muted ms-2 mb-1">10:27 AM</small>
                                    </div>
                                </div>
                                
                                <!-- Buyer Message -->
                                <div class="d-flex flex-row-reverse mb-3">
                                    <div class="card message-card sent-message">
                                        <div class="card-body py-2 px-3">
                                            <p class="mb-0">Yes, that works perfectly for me! I'll make sure to be home during that time.</p>
                                        </div>
                                        <small class="text-muted me-2 mb-1 text-end">10:30 AM</small>
                                    </div>
                                </div>
                                
                                <!-- Farmer Message with Image -->
                                <div class="d-flex mb-3">
                                    <img src="https://via.placeholder.com/40x40?text=GV" class="rounded-circle me-2" width="40" height="40" alt="Green Valley Farm">
                                    <div class="card message-card received-message">
                                        <div class="card-body py-2 px-3">
                                            <p>Perfect! Here's a photo of your tomatoes - just harvested this morning!</p>
                                            <img src="https://via.placeholder.com/300x200?text=Fresh+Tomatoes" class="img-fluid rounded mb-2" alt="Fresh Tomatoes">
                                            <p class="mb-0">We've also included a complimentary bunch of basil with your order as a thank you for being a loyal customer.</p>
                                        </div>
                                        <small class="text-muted ms-2 mb-1">10:35 AM</small>
                                    </div>
                                </div>
                                
                                <!-- Buyer Message -->
                                <div class="d-flex flex-row-reverse mb-3">
                                    <div class="card message-card sent-message">
                                        <div class="card-body py-2 px-3">
                                            <p class="mb-0">Wow, they look amazing! And thank you so much for the basil - that's very kind of you. I can't wait to make a fresh tomato basil salad with these!</p>
                                        </div>
                                        <small class="text-muted me-2 mb-1 text-end">10:40 AM</small>
                                    </div>
                                </div>
                                
                                <!-- Farmer Message -->
                                <div class="d-flex mb-3">
                                    <img src="https://via.placeholder.com/40x40?text=GV" class="rounded-circle me-2" width="40" height="40" alt="Green Valley Farm">
                                    <div class="card message-card received-message">
                                        <div class="card-body py-2 px-3">
                                            <p class="mb-0">That sounds delicious! If you enjoy it, we'd love to see a photo or hear how it turned out. Is there anything else you need help with?</p>
                                        </div>
                                        <small class="text-muted ms-2 mb-1">10:42 AM</small>
                                    </div>
                                </div>
                                
                                <!-- Buyer Message -->
                                <div class="d-flex flex-row-reverse mb-3">
                                    <div class="card message-card sent-message">
                                        <div class="card-body py-2 px-3">
                                            <p class="mb-0">I'll definitely share a photo! Actually, I was wondering if you'll have any fresh zucchini available soon? I'd love to add that to my next order.</p>
                                        </div>
                                        <small class="text-muted me-2 mb-1 text-end">10:45 AM</small>
                                    </div>
                                </div>
                                
                                <!-- Farmer Message -->
                                <div class="d-flex align-items-center mb-1">
                                    <img src="https://via.placeholder.com/40x40?text=GV" class="rounded-circle me-2" width="40" height="40" alt="Green Valley Farm">
                                    <small class="text-muted"><em>typing...</em></small>
                                </div>
                            </div>
                              <!-- Message Input -->
                            <div class="card-footer bg-white">
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button">
                                        <i class="bi bi-paperclip"></i>
                                    </button>
                                    <input type="text" id="chat-message-input" class="form-control" placeholder="Type a message..." aria-label="Type a message">
                                    <button id="chat-send-btn" class="btn btn-primary" type="button">
                                        <i class="bi bi-send"></i> Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- New Chat Modal -->
    <div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newChatModalLabel">Start a New Chat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">                    <div class="mb-3">
                        <label for="userSearch" class="form-label">Search for a farm or supplier</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="userSearch" placeholder="Search farms...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="searchResults" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
                        <!-- Search results will be populated here -->
                    </div>
                    
                    <h6>Suggested Farms</h6>
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action">
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/40x40?text=HH" class="rounded-circle me-3" alt="Herb Haven">
                                <div>
                                    <h6 class="mb-0">Herb Haven</h6>
                                    <small class="text-muted">Specializes in organic herbs and spices</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action">
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/40x40?text=HC" class="rounded-circle me-3" alt="Happy Cow Dairy">
                                <div>
                                    <h6 class="mb-0">Happy Cow Dairy</h6>
                                    <small class="text-muted">Fresh milk and dairy products</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action">
                            <div class="d-flex align-items-center">
                                <img src="https://via.placeholder.com/40x40?text=RF" class="rounded-circle me-3" alt="Riverdale Farm">
                                <div>
                                    <h6 class="mb-0">Riverdale Farm</h6>
                                    <small class="text-muted">Seasonal vegetables and fruits</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" disabled>Start Chat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    
    <!-- Custom JavaScript for Chat Page -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-scroll to bottom of chat
            const chatContainer = document.querySelector('.chat-messages');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Send message on Enter key
            const messageInput = document.querySelector('.input-group input');
            const sendButton = document.querySelector('.input-group .btn-primary');
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.trim() !== '') {
                    sendMessage();
                }
            });
            
            sendButton.addEventListener('click', function() {
                if (messageInput.value.trim() !== '') {
                    sendMessage();
                }
            });
            
            // Contact selection
            const contactLinks = document.querySelectorAll('.list-group-item-action');
            contactLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Remove active class from all contacts
                    contactLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked contact
                    this.classList.add('active');
                    
                    // In a real app, this would load the conversation with the selected contact
                    // For now, we just update the header with the contact name
                    const contactName = this.querySelector('h6').textContent;
                    document.querySelector('.card-header h5').textContent = contactName;
                    
                    // Reset typing indicator
                    document.querySelector('.chat-messages small em').textContent = '';
                    setTimeout(() => {
                        document.querySelector('.chat-messages small em').textContent = 'typing...';
                    }, 2000);
                });
            });
            
            function sendMessage() {
                const message = messageInput.value;
                
                // Create new message element
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const timeString = `${hours}:${minutes}`;
                
                const messageHTML = `
                    <div class="d-flex flex-row-reverse mb-3">
                        <div class="card message-card sent-message">
                            <div class="card-body py-2 px-3">
                                <p class="mb-0">${message}</p>
                            </div>
                            <small class="text-muted me-2 mb-1 text-end">${timeString}</small>
                        </div>
                    </div>
                `;
                
                // Insert message before typing indicator
                const typingIndicator = document.querySelector('.chat-messages .align-items-center');
                typingIndicator.insertAdjacentHTML('beforebegin', messageHTML);
                
                // Clear input
                messageInput.value = '';
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Simulate response (in a real app, this would come from the server)
                setTimeout(() => {
                    const responseHTML = `
                        <div class="d-flex mb-3">
                            <img src="https://via.placeholder.com/40x40?text=GV" class="rounded-circle me-2" width="40" height="40" alt="Green Valley Farm">
                            <div class="card message-card received-message">
                                <div class="card-body py-2 px-3">
                                    <p class="mb-0">Yes! Our zucchini will be ready next week. I'll make sure to let you know as soon as they're available for ordering!</p>
                                </div>
                                <small class="text-muted ms-2 mb-1">${timeString}</small>
                            </div>
                        </div>
                    `;
                    
                    typingIndicator.insertAdjacentHTML('beforebegin', responseHTML);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    // Hide typing indicator
                    document.querySelector('.chat-messages small em').textContent = '';
                }, 3000);
                
                // Show typing indicator
                document.querySelector('.chat-messages small em').textContent = 'typing...';
            }
        });
    </script>
    
    <style>
        /* Custom styles for chat interface */
        .message-card {
            max-width: 75%;
            border-radius: 15px;
        }
        
        .sent-message {
            background-color: #dcf8c6;
            border-color: #dcf8c6;
        }
        
        .received-message {
            background-color: #f5f5f5;
            border-color: #f5f5f5;
        }
        
        .chat-messages {
            background-color: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .order-link {
            color: #007bff;
            text-decoration: none;
        }
          .order-link:hover {
            text-decoration: underline;
        }
    </style>
    
    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script>
        // Make Stomp available globally
        const Stomp = StompJs.Stomp;
    </script>
    
    <!-- Chat JavaScript -->
    <script src="/js/chat.js"></script>
</body>
</html>
