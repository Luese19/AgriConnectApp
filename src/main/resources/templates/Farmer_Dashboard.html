<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">
    <meta charset="UTF-8">
    <title>Farmer Dashboard</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Removed custom <style> block to use global styles -->
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div class="container-fluid">
        <div class="row">
            <nav th:replace="~{fragments/sidebar :: sidebar}" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse p-0 sidebar-fixed"></nav>
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Home Screen / Dashboard -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="bi bi-house-door me-2"></i>Dashboard</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
                            <i class="bi bi-calendar me-1"></i>
                            This week
                        </button>
                        <a href="/chat" class="btn btn-sm btn-success ms-2">
                            <i class="bi bi-chat-dots me-1"></i>Chat
                        </a>
                    </div>
                </div>                <!-- Quick Stats Section -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card dashboard-card stat-card card-inventory">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="stat-label">Total Inventory</h6>
                                    <h3 class="stat-value" th:text="${totalInventory ?: '24'}">24</h3>
                                    <p class="mb-0">Items in stock</p>
                                </div>
                                <div class="position-relative">
                                    <i class="bi bi-box text-success"></i>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success" 
                                          th:text="${totalInventory ?: '24'}">24</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card dashboard-card stat-card card-orders">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="stat-label">Order Requests</h6>
                                    <h3 class="stat-value" th:text="${orderRequests != null ? orderRequests.size() : '0'}">0</h3>
                                    <p class="mb-0">Total orders</p>
                                </div>
                                <div class="position-relative">
                                    <i class="bi bi-bag-check text-primary"></i>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary" 
                                          th:text="${orderRequests != null ? orderRequests.size() : '0'}">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Removed Monthly Revenue Card -->
                </div>                <div class="row">
                    <!-- Order Requests Section - Full Width -->
                    <div class="col-12">                        <!-- Order Requests Section -->
                        <section id="orders" class="mb-4">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h2><i class="bi bi-bag-check me-2 text-primary"></i>Order Requests</h2>
                                <div class="d-flex gap-2">                                    <!-- Search Orders -->
                                    <div class="input-group order-search-input">
                                        <input type="text" class="form-control form-control-sm" placeholder="Search orders..." id="orderSearch">
                                        <button class="btn btn-outline-secondary btn-sm" type="button">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                    <!-- Filter Dropdown -->
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="orderFilterDropdown" data-bs-toggle="dropdown">
                                            <i class="bi bi-funnel me-1"></i>Filter Orders
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="orderFilterDropdown">
                                            <li><a class="dropdown-item filter-option" href="#" data-filter="all">
                                                <i class="bi bi-list-ul me-2"></i>All Orders
                                            </a></li>
                                            <li><a class="dropdown-item filter-option" href="#" data-filter="pending">
                                                <i class="bi bi-clock me-2"></i>Pending Orders
                                            </a></li>
                                            <li><a class="dropdown-item filter-option" href="#" data-filter="accepted">
                                                <i class="bi bi-check-circle me-2"></i>Accepted Orders
                                            </a></li>
                                            <li><a class="dropdown-item filter-option" href="#" data-filter="delivered">
                                                <i class="bi bi-truck me-2"></i>Delivered Orders
                                            </a></li>
                                            <li><a class="dropdown-item filter-option" href="#" data-filter="canceled">
                                                <i class="bi bi-x-circle me-2"></i>Canceled Orders
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card dashboard-card enhanced-order-table">
                                <div class="card-header bg-light">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <h6 class="mb-0 text-muted">
                                                <span id="orderCount" th:text="${orderRequests != null ? orderRequests.size() : 0}">0</span> 
                                                order(s) found
                                            </h6>
                                        </div>
                                        <div class="col-auto">
                                            <button class="btn btn-sm btn-outline-primary" id="refreshOrders" data-bs-toggle="tooltip" title="Refresh Orders">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-order-requests mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col" class="sortable" data-sort="orderId">
                                                        <i class="bi bi-hash me-1"></i>Order ID
                                                        <i class="bi bi-arrow-up-down sort-icon"></i>
                                                    </th>
                                                    <th scope="col" class="sortable" data-sort="customer">
                                                        <i class="bi bi-person me-1"></i>Customer
                                                        <i class="bi bi-arrow-up-down sort-icon"></i>
                                                    </th>
                                                    <th scope="col">
                                                        <i class="bi bi-geo-alt me-1"></i>Delivery Address
                                                    </th>
                                                    <th scope="col">
                                                        <i class="bi bi-box-seam me-1"></i>Products
                                                    </th>
                                                    <th scope="col" class="sortable" data-sort="amount">
                                                        <i class="bi bi-currency-dollar me-1"></i>Amount
                                                        <i class="bi bi-arrow-up-down sort-icon"></i>
                                                    </th>
                                                    <th scope="col">
                                                        <i class="bi bi-info-circle me-1"></i>Status
                                                    </th>
                                                    <th scope="col" class="text-center">
                                                        <i class="bi bi-gear me-1"></i>Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="orderTableBody">
                                                <tr th:each="order, iterStat : ${orderRequests}" class="order-row" 
                                                    th:data-status="${order.status}" 
                                                    th:data-order-id="${order.orderId}"
                                                    th:data-customer="${order.buyerId}">                                                    <td>
                                                        <span class="fw-bold text-primary order-id-text" th:text="'#' + ${#strings.abbreviate(order.orderId, 12)}"></span>
                                                        <small class="text-muted" th:text="${#temporals.format(order.orderDate, 'MMM dd, yyyy')}">May 26, 2025</small>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm me-2">
                                                                <i class="bi bi-person-circle text-secondary person-circle-lg"></i>
                                                            </div>
                                                            <div class="flex-grow-1 customer-info">
                                                                <div class="fw-semibold customer-name" th:text="${order.buyerId}" th:title="${order.buyerId}">Customer Name</div>
                                                                <small class="text-muted">Verified Buyer</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="address-cell">
                                                            <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                                                            <span class="address-text" th:text="${order.deliveryAddress}" th:title="${order.deliveryAddress}">Address</span>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" data-bs-toggle="tooltip" title="View on map">
                                                                <i class="bi bi-map text-primary"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="product-cell">
                                                            <span class="product-names product-text" 
                                                                  th:text="${order.itemNames != null ? order.itemNames.toString().replace('[','').replace(']','') : 'No items'}"
                                                                  th:title="${order.itemNames != null ? order.itemNames.toString().replace('[','').replace(']','') : 'No items'}">Products</span>
                                                            <small class="d-block text-muted">
                                                                <span th:text="${order.itemNames != null ? order.itemNames.size() : 0}">0</span> item(s)
                                                            </small>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="amount-cell">
                                                            <span class="fw-bold text-success fs-6" th:text="'₱' + ${#numbers.formatDecimal(order.totalAmount, 1, 'COMMA', 2, 'POINT')}">₱0.00</span>
                                                            <small class="d-block text-muted">Total</small>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge status-badge" 
                                                              th:classappend="${order.status == 'pending' ? 'bg-warning text-dark' : 
                                                                              order.status == 'accepted' ? 'bg-info text-white' : 
                                                                              order.status == 'delivered' ? 'bg-success' : 
                                                                              order.status == 'canceled' ? 'bg-danger' : 'bg-secondary'}" 
                                                              th:text="${order.status}">Status</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="action-buttons">
                                                            <!-- View Details Button -->
                                                            <button class="btn btn-sm btn-outline-info me-1" 
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#orderDetailsModal"
                                                                    th:data-order-id="${order.orderId}"
                                                                    title="View Details">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                            
                                                            <!-- Accept/Reject Buttons for Pending Orders -->
                                                            <div th:if="${order.status == 'pending'}" class="d-inline">
                                                                <form th:action="@{/farmer/order/accept}" method="post" class="d-inline">
                                                                    <input type="hidden" name="orderId" th:value="${order.orderId}" />
                                                                    <button class="btn btn-sm btn-outline-success me-1" type="submit" 
                                                                            data-bs-toggle="tooltip" title="Accept Order"
                                                                            onclick="return confirm('Are you sure you want to accept this order?')">
                                                                        <i class="bi bi-check-lg"></i>
                                                                    </button>
                                                                </form>
                                                                <form th:action="@{/farmer/order/reject}" method="post" class="d-inline">
                                                                    <input type="hidden" name="orderId" th:value="${order.orderId}" />
                                                                    <button class="btn btn-sm btn-outline-danger" type="submit" 
                                                                            data-bs-toggle="tooltip" title="Reject Order"
                                                                            onclick="return confirm('Are you sure you want to reject this order?')">
                                                                        <i class="bi bi-x-lg"></i>
                                                                    </button>
                                                                </form>
                                                            </div>
                                                            
                                                            <!-- Contact Button for Accepted Orders -->
                                                            <div th:if="${order.status == 'accepted'}" class="d-inline">
                                                                <button class="btn btn-sm btn-outline-primary me-1" 
                                                                        data-bs-toggle="tooltip" title="Contact Customer">
                                                                    <i class="bi bi-chat-dots"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-success" 
                                                                        data-bs-toggle="tooltip" title="Mark as Delivered">
                                                                    <i class="bi bi-truck"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>                                                <!-- Empty State -->
                                                <tr id="emptyState" class="text-center empty-state-hidden">
                                                    <td colspan="7" class="py-4">
                                                        <i class="bi bi-inbox text-muted empty-state-icon"></i>
                                                        <h5 class="mt-3 text-muted">No orders found</h5>
                                                        <p class="text-muted">Try adjusting your search or filter criteria</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <!-- Pagination -->
                                <div class="card-footer bg-light">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <small class="text-muted">
                                                Showing <span id="showingStart">1</span> to <span id="showingEnd">10</span> 
                                                of <span id="totalOrders" th:text="${orderRequests != null ? orderRequests.size() : 0}">0</span> orders
                                            </small>
                                        </div>
                                        <div class="col-auto">
                                            <nav aria-label="Order pagination">
                                                <ul class="pagination pagination-sm mb-0">
                                                    <li class="page-item disabled">
                                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                                    </li>
                                                    <li class="page-item active">
                                                        <a class="page-link" href="#">1</a>
                                                    </li>
                                                    <li class="page-item">
                                                        <a class="page-link" href="#">2</a>
                                                    </li>
                                                    <li class="page-item">
                                                        <a class="page-link" href="#">Next</a>
                                                    </li>
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>                        </section>
                    </div>
                </div>
            </main>
        </div>    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">
                        <i class="bi bi-receipt me-2"></i>Order Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3"><i class="bi bi-info-circle me-2"></i>Order Information</h6>
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="fw-semibold">Order ID:</td>
                                    <td id="modalOrderId">#12345</td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Order Date:</td>
                                    <td id="modalOrderDate">May 26, 2025</td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Status:</td>
                                    <td><span id="modalOrderStatus" class="badge bg-warning">Pending</span></td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Total Amount:</td>
                                    <td class="text-success fw-bold" id="modalTotalAmount">₱0.00</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3"><i class="bi bi-person me-2"></i>Customer Information</h6>
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="fw-semibold">Customer:</td>
                                    <td id="modalCustomerName">Customer Name</td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Contact:</td>
                                    <td id="modalCustomerContact">+63 xxx xxx xxxx</td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">Email:</td>
                                    <td id="modalCustomerEmail">customer@email.com</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6 class="text-muted mb-3"><i class="bi bi-geo-alt me-2"></i>Delivery Address</h6>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-0" id="modalDeliveryAddress">
                                123 Main Street, Barangay Sample, City, Province, 1234
                            </p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6 class="text-muted mb-3"><i class="bi bi-box-seam me-2"></i>Order Items</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="modalOrderItems">
                                <tr>
                                    <td>Sample Product</td>
                                    <td>1 kg</td>
                                    <td>₱100.00</td>
                                    <td>₱100.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3"><i class="bi bi-clock-history me-2"></i>Order Timeline</h6>
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-primary"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Order Placed</h6>
                                        <small class="text-muted">May 26, 2025 10:30 AM</small>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-warning"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Pending Review</h6>
                                        <small class="text-muted">Waiting for farmer approval</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3"><i class="bi bi-chat-dots me-2"></i>Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-telephone me-2"></i>Contact Customer
                                </button>
                                <button class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-printer me-2"></i>Print Order Details
                                </button>
                                <button class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-download me-2"></i>Export as PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <div id="modalActions">
                        <!-- Actions will be dynamically populated based on order status -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Crop Modal -->
    <div class="modal fade" id="addCropModal" tabindex="-1" aria-labelledby="addCropModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCropModalLabel">Add New Crop</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/farmer/add-crop}" method="post" th:object="${newItem}" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="cropName" class="form-label">Crop Name</label>
                            <input type="text" class="form-control" id="cropName" th:field="*{itemName}" placeholder="e.g. Organic Tomatoes">
                        </div>
                        <div class="mb-3">
                            <label for="cropCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="cropCategory" th:field="*{itemCategory}" placeholder="e.g. Vegetables">
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="cropQuantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="cropQuantity" th:field="*{itemQuantity}" placeholder="e.g. 500">
                            </div>
                            <div class="col">
                                <label for="cropStatus" class="form-label">Status</label>
                                <input type="text" class="form-control" id="cropStatus" th:field="*{itemStatus}" placeholder="e.g. In Stock">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="cropPrice" class="form-label">Unit Price</label>
                                <input type="text" class="form-control" id="cropPrice" th:field="*{itemPrice}" placeholder="0.00">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cropDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="cropDescription" th:field="*{itemDescription}" rows="3" placeholder="Enter crop description..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="cropImage" class="form-label">Upload Image</label>
                            <input class="form-control" type="file" id="cropImage" name="cropImage" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="cropLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="cropLocation" th:field="*{location}" placeholder="e.g. Nairobi, Kenya">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Add Crop</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3 bg-light text-center text-muted">
        <div class="container">
            <small>&copy; 2025 Farmer's Dashboard. All rights reserved.</small>
        </div>
    </footer>    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:src="@{/js/firebase-config.js}"></script>
    <script th:src="@{/js/dashboard.js}"></script>
    
    <!-- Enhanced Order Table JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Order search functionality
            const orderSearch = document.getElementById('orderSearch');
            const orderTableBody = document.getElementById('orderTableBody');
            const orderRows = orderTableBody.querySelectorAll('.order-row');
            const emptyState = document.getElementById('emptyState');
            const orderCount = document.getElementById('orderCount');
            
            function updateOrderCount() {
                const visibleRows = orderTableBody.querySelectorAll('.order-row:not(.empty-state-hidden)');
                orderCount.textContent = visibleRows.length;
                  if (visibleRows.length === 0) {
                    emptyState.classList.remove('empty-state-hidden');
                } else {
                    emptyState.classList.add('empty-state-hidden');
                }
            }
            
            if (orderSearch) {
                orderSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    orderRows.forEach(row => {
                        const orderId = row.getAttribute('data-order-id').toLowerCase();
                        const customer = row.getAttribute('data-customer').toLowerCase();
                        const productCell = row.querySelector('.product-names');
                        const products = productCell ? productCell.textContent.toLowerCase() : '';
                          if (orderId.includes(searchTerm) || 
                            customer.includes(searchTerm) || 
                            products.includes(searchTerm)) {
                            row.classList.remove('empty-state-hidden');
                        } else {
                            row.classList.add('empty-state-hidden');
                        }
                    });
                    
                    updateOrderCount();
                });
            }
            
            // Filter functionality
            const filterOptions = document.querySelectorAll('.filter-option');
            filterOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    const filter = this.getAttribute('data-filter');
                    
                    orderRows.forEach(row => {
                        const status = row.getAttribute('data-status').toLowerCase();
                          if (filter === 'all' || status === filter) {
                            row.classList.remove('empty-state-hidden');
                        } else {
                            row.classList.add('empty-state-hidden');
                        }
                    });
                    
                    updateOrderCount();
                    
                    // Update dropdown button text
                    const dropdownButton = document.getElementById('orderFilterDropdown');
                    const icon = this.querySelector('i').className;
                    const text = this.textContent.trim();
                    dropdownButton.innerHTML = `<i class="${icon} me-1"></i>${text}`;
                });
            });
            
            // Sorting functionality
            const sortableHeaders = document.querySelectorAll('.sortable');
            let currentSort = { column: null, direction: 'asc' };
            
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    const rows = Array.from(orderTableBody.querySelectorAll('.order-row'));
                    
                    // Toggle sort direction
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.direction = 'asc';
                    }
                    currentSort.column = column;
                    
                    // Update sort icons
                    sortableHeaders.forEach(h => {
                        const icon = h.querySelector('.sort-icon');
                        icon.className = 'bi bi-arrow-up-down sort-icon';
                    });
                    
                    const currentIcon = this.querySelector('.sort-icon');
                    currentIcon.className = currentSort.direction === 'asc' ? 
                        'bi bi-sort-up sort-icon' : 'bi bi-sort-down sort-icon';
                    
                    // Sort rows
                    rows.sort((a, b) => {
                        let aVal, bVal;
                        
                        switch(column) {
                            case 'orderId':
                                aVal = parseInt(a.getAttribute('data-order-id'));
                                bVal = parseInt(b.getAttribute('data-order-id'));
                                break;
                            case 'customer':
                                aVal = a.getAttribute('data-customer').toLowerCase();
                                bVal = b.getAttribute('data-customer').toLowerCase();
                                break;
                            case 'amount':
                                aVal = parseFloat(a.querySelector('.amount-cell .fw-bold').textContent.replace('₱', '').replace(',', ''));
                                bVal = parseFloat(b.querySelector('.amount-cell .fw-bold').textContent.replace('₱', '').replace(',', ''));
                                break;
                            default:
                                return 0;
                        }
                        
                        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                    
                    // Reorder DOM elements
                    rows.forEach(row => orderTableBody.appendChild(row));
                });
            });
            
            // Order details modal functionality
            const orderDetailsModal = document.getElementById('orderDetailsModal');
            if (orderDetailsModal) {
                orderDetailsModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const orderId = button.getAttribute('data-order-id');
                    const row = document.querySelector(`[data-order-id="${orderId}"]`);
                    
                    if (row) {
                        // Populate modal with order data
                        document.getElementById('modalOrderId').textContent = '#' + orderId;
                        document.getElementById('modalCustomerName').textContent = row.getAttribute('data-customer');
                        document.getElementById('modalDeliveryAddress').textContent = row.querySelector('.address-cell span').textContent;
                        
                        // Set status badge
                        const status = row.getAttribute('data-status');
                        const modalStatus = document.getElementById('modalOrderStatus');
                        modalStatus.textContent = status;
                        modalStatus.className = `badge ${getStatusBadgeClass(status)}`;
                        
                        // Set amount
                        const amount = row.querySelector('.amount-cell .fw-bold').textContent;
                        document.getElementById('modalTotalAmount').textContent = amount;
                        
                        // Update modal actions based on status
                        updateModalActions(status, orderId);
                    }
                });
            }
            
            function getStatusBadgeClass(status) {
                switch(status.toLowerCase()) {
                    case 'pending': return 'bg-warning text-dark';
                    case 'accepted': return 'bg-info text-white';
                    case 'delivered': return 'bg-success';
                    case 'canceled': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }
            
            function updateModalActions(status, orderId) {
                const modalActions = document.getElementById('modalActions');
                let actionsHTML = '';
                
                if (status === 'pending') {
                    actionsHTML = `
                        <form action="/farmer/order/accept" method="post" class="d-inline me-2">
                            <input type="hidden" name="orderId" value="${orderId}" />
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-lg me-2"></i>Accept Order
                            </button>
                        </form>
                        <form action="/farmer/order/reject" method="post" class="d-inline">
                            <input type="hidden" name="orderId" value="${orderId}" />
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-x-lg me-2"></i>Reject Order
                            </button>
                        </form>
                    `;
                } else if (status === 'accepted') {
                    actionsHTML = `
                        <button type="button" class="btn btn-primary me-2">
                            <i class="bi bi-chat-dots me-2"></i>Contact Customer
                        </button>
                        <button type="button" class="btn btn-success">
                            <i class="bi bi-truck me-2"></i>Mark as Delivered
                        </button>
                    `;
                }
                
                modalActions.innerHTML = actionsHTML;
            }
            
            // Refresh orders functionality
            const refreshButton = document.getElementById('refreshOrders');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    // Add spinning animation
                    const icon = this.querySelector('i');
                    icon.className = 'bi bi-arrow-repeat';
                    icon.style.animation = 'spin 1s linear infinite';
                    
                    // Simulate refresh (in real app, this would reload data)
                    setTimeout(() => {
                        icon.style.animation = '';
                        icon.className = 'bi bi-arrow-clockwise';
                        
                        // Show success message
                        const tooltip = bootstrap.Tooltip.getInstance(this);
                        if (tooltip) {
                            tooltip.setContent({'.tooltip-inner': 'Orders refreshed!'});
                            setTimeout(() => {
                                tooltip.setContent({'.tooltip-inner': 'Refresh Orders'});
                            }, 2000);
                        }
                    }, 1000);
                });
            }
        });
        
        // Add spinning animation for refresh button
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
